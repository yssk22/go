# See the guide: https://circleci.com/docs/language-go/
# but $HOME/.go_project is not included in $GOPATH actually
machine:
  environment:
    GOPATH: "${HOME}/.go_workspace:/usr/local/go_workspace:${HOME}/.go_project"
    SRCDIR: "${HOME}/.go_project/src/github.com/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}"

dependencies:
  override:
    - sudo /opt/google-cloud-sdk/bin/gcloud --quiet components install app-engine-go
    - sudo chown -R ubuntu.ubuntu /opt/google-cloud-sdk/
    - go get -u github.com/jstemmer/go-junit-report
    - mkdir -p "${HOME}/.go_project/src/github.com/${CIRCLE_PROJECT_USERNAME}"
    - ln -sf "${HOME}/${CIRCLE_PROJECT_REPONAME}/" "${HOME}/.go_project/src/github.com/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}"
    - cd ${SRCDIR} && go get ./...
    - cd ${SRCDIR} && git tag -d master

test:
  override:
    - cd ${SRCDIR} && go build ./... # Check packages are buildable (go-junit-report doesn't check it)
    - mkdir -p $CIRCLE_TEST_REPORTS/golang
    - cd ${SRCDIR} && go test -v $(go list ./... | grep -v vendor) | go-junit-report -set-exit-code=true > $CIRCLE_TEST_REPORTS/golang/junit.xml

deployment:
  develop:
    branch: develop
    commands:
      - git config --global user.name "yssk22"
      - git config --global user.email "yssk22@gmail.com"
      - git branch -D master
      - git fetch origin master
      - git checkout master
      - git merge origin/master
      - git merge develop --no-ff -m "Merge 'develop' (CI auto merge)"
      - git push origin master
