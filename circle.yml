# See the guide: https://circleci.com/docs/language-go/
# but $HOME/.go_project is not included in $GOPATH actually
machine:
  environment:
    GOPATH: "${HOME}/.go_workspace:/usr/local/go_workspace:${HOME}/.go_project"

dependencies:
  override:
    - mkdir -p "${HOME}/.go_project/src/github.com/${CIRCLE_PROJECT_USERNAME}"
    - ln -sf "${HOME}/${CIRCLE_PROJECT_REPONAME}/" "${HOME}/.go_project/src/github.com/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}"

test:
  override:
    - go get -u github.com/jstemmer/go-junit-report
    - mkdir -p $CIRCLE_TEST_REPORTS/golang
    - go test -v $(go list ./... | grep -v vendor) | go-junit-report -set-exit-code=true > $CIRCLE_TEST_REPORTS/golang/junit.xml:
        pwd:
          ../.go_project/src/github.com/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}

deployment:
  develop:
    branch: develop
    commands:
      - git config --global user.name "yssk22"
      - git config --global user.email "yssk22@gmail.com"
      - git fetch origin master
      - git checkout master
      - git merge develop --no-ff -m "Merge 'develop' (CI auto merge)"
      - git push origin master