# See the guide: https://circleci.com/docs/language-go/
# but $HOME/.go_project is not included in $GOPATH actually
machine:
  environment:
    GOROOT: "/opt/google-cloud-sdk/platform/google_appengine/goroot/"
    GOAPP: "/opt/google-cloud-sdk/platform/google_appengine/goapp"
    GOPATH: "${HOME}/.go_workspace:/usr/local/go_workspace:${HOME}/.go_project"
    SRCDIR: "${HOME}/.go_project/src/github.com/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}"

dependencies:
  override:
    - chown -R ubuntu.ubuntu /opt/google-cloud-sdk/
    - /opt/google-cloud-sdk/bin/gcloud --quiet components install app-engine-go
    - chmod 755 ${GOAPP}
    - ${GOAPP} get -u github.com/jstemmer/go-junit-report
    - mkdir -p "${HOME}/.go_project/src/github.com/${CIRCLE_PROJECT_USERNAME}"
    - ln -sf "${HOME}/${CIRCLE_PROJECT_REPONAME}/" "${HOME}/.go_project/src/github.com/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}"
    - cd ${SRCDIR} && ${GOAPP} get ./...

test:
  override:
    - cd ${SRCDIR} && ${GOAPP} build ./... # Check packages are buildable (go-junit-report doesn't check it)
    - mkdir -p $CIRCLE_TEST_REPORTS/golang
    - cd ${SRCDIR} && ${GOAPP} test -v $(go list ./... | grep -v vendor) | go-junit-report -set-exit-code=true > $CIRCLE_TEST_REPORTS/golang/junit.xml

deployment:
  develop:
    branch: develop
    commands:
      - git config --global user.name "yssk22"
      - git config --global user.email "yssk22@gmail.com"
      - git branch -D master
      - git fetch origin master
      - git checkout master
      - git merge develop --no-ff -m "Merge 'develop' (CI auto merge)"
      - git push origin master
